# test-environments

Scripts to setup reproductible test environments for `live-common` and `Vault`.

## Prerequisites (common to all scripts)

* OS: Linux or macOS
* Nvm (https://github.com/nvm-sh/nvm)
* Python 3 (https://www.python.org/downloads/)

## Live-common

The `setup_live.sh` script:
* Compiles `lib-ledger-core` (build type: Release, target: host OS)
* Creates the bindings
* Associates them with `live-common` using yalc
* Creates an ephemeral `ledger-live` alias configured for testing purposes

### Prerequisites

* Node 12 (Linux: `nvm install 12`; macOS: `nvm install 12 64`)
* `PyYAML` Python package (https://pypi.org/project/PyYAML/)
* yalc (https://www.npmjs.com/package/yalc)
* a C++ compiler (g++, clang++, ...)

### Run

```
$ source ./setup.sh <coin name>
. . .
$ ledger-live . . .
```

Example:

```
$ source ./setup.sh algorand
. . .
$ ledger-live sync -c algorand
```

### Available coins

**Algorand**
* MainNet: `algorand`
* TestNet: `algorand_test`
* Bot dev: `algorand_bot_dev`

### Note: use of `source`

`source` is used in order to be able to use the ephemeral `ledger-live` alias generated by the script in the shell.

Important: once the terminal/shell is closed, the alias is removed.

## Vault

The `setup_vault.sh` script:
* Compiles `lib-ledger-core` (build type: Release, target: Linux (Debian))
* Encapsulates the resulting compiled library in a JAR file
* Builds a custom `ledger-wallet-daemon` Docker image embedding this JAR file
* Runs the components of the Vault

### Prerequisites

* Docker
* Docker Compose
* Node 10 (Linux: `nvm install 10`; macOS: `nvm install 10 64`)
* Default Vault environment variables (set and sourced, or set in `.env` file)
* `click` Python package (https://pypi.org/project/click/) (for `vault-integration`, `./vault_compose` command)
* Being logged in to Docker Hub from account belonging to `ledgerhq` organization

### Setup

In `setup_vault.sh`, check the Vault-related environment variables (if needed, add those that have to overload the default ones).

### Run

```
$ ./setup_vault.sh <coin name>
```

Example:

```
$ ./setup_vault.sh algorand
```

## Configure a new coin

Edit `config.yml` by adding the configuration details related to the new coin with the following structure:

```
<coin_name>:
    live:
        libcore:
            repository: <repository uri> 
            branch: <branch name>
        bindings:
            repository: <repository uri> 
            branch: <branch name>
        live_common:
            repository: <repository uri> 
            branch: <branch name>
        cli_options:
            - <optional: CLI option #1>
            - <optional: CLI option #2>
            - <optional: CLI option #3 . . .>
    vault:
        libcore:
            repository: <repository uri> 
            branch: <branch name>
        wallet_daemon:
            repository: <repository uri> 
            branch: <branch name>
        vault_integration: 
            repository: <repository uri> 
            branch: <branch name>
        vault_front:
           repository: <repository uri> 
            branch: <branch name>
```

Note that the `live` (corresponding to live-common) and the `vault` keys are optional; in other words, the configuration can be set for live-common only, the Vault only, or both of them.

When adding a new coin in the configuration file, please edit the current file (`README.md`) in order to also include it in the `Available coins` Section.
